# LEGACY-001: Remove Core Value Classes

## Metadata
- **ID**: LEGACY-001
- **Priority**: HIGH
- **Estimated Duration**: 1 day
- **Dependencies**: MIGRATE-001, MIGRATE-002, MIGRATE-003, REACT-001~006 (after all tests pass)
- **Status**: TODO
- **Assignee**: TBD
- **Related Documents**: [LEGACY_REMOVAL_PLAN.md](../advanced/LEGACY_REMOVAL_PLAN.md)

---

## Overview

### What are we changing?

Remove the legacy core value system (`core/value.h`, `core/value.cpp`, `core/container.h`, `core/container.cpp`) and completely replace it with the variant-based system.

**Files to remove**:
- `core/value.h` - Abstract value base class (~1,200 LOC)
- `core/value.cpp` - Value implementation
- `core/container.h` - Legacy container class (~800 LOC)
- `core/container.cpp` - Container implementation
- `core/optimized_value.h` - Performance optimization (deprecated)
- `core/value_pool.h` - Memory pooling (deprecated)

**Files to keep**:
- `core/value_types.h` - Type enumeration (shared with variant_value_v2)
- `core/value_types.cpp` - Type utilities

**Total LOC to remove**: ~2,500 lines

---

## Changes

### How will we implement this?

#### 1. Dependency Check

**Pre-removal checklist**:
```bash
# Check value.h usage
grep -r "#include.*value\.h" --include="*.cpp" --include="*.h"

# Check container.h usage
grep -r "#include.*container\.h" --include="*.cpp" --include="*.h"
```

**Expected dependencies**:
- `values/*.h` - To be removed
- `integration/messaging_integration.h` - Migrated in REACT-005
- `tests/*.cpp` - Migrated in REACT-001
- `benchmarks/*.cpp` - Migrated in REACT-003
- `examples/*.cpp` - Migrated in REACT-004

#### 2. File Removal Order

**Step 1**: Remove optimized_value.h, value_pool.h (no usage)
```bash
rm core/optimized_value.h
rm core/value_pool.h
```

**Step 2**: container.h â†’ Create thread_safe_container.h wrapper
```cpp
// core/container.h (new version - compatibility wrapper)
#pragma once

#include "internal/thread_safe_container.h"

namespace container_module {

// Type alias for backward compatibility
using value_container = thread_safe_container;

// Map legacy API to new API
[[deprecated("Use thread_safe_container directly")]]
using container = thread_safe_container;

}  // namespace container_module
```

**Step 3**: Remove value.h (after all dependencies resolved)

#### 3. CMakeLists.txt Update

```cmake
# Sources to remove
set(LEGACY_SOURCES  # To be removed
    ${CMAKE_CURRENT_SOURCE_DIR}/core/value.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/core/container.cpp
)

# Sources to keep
set(CORE_SOURCES
    ${CMAKE_CURRENT_SOURCE_DIR}/core/value_types.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/internal/variant_value_v2.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/internal/thread_safe_container.cpp
    # ...
)
```

#### 4. Include Path Update

**Before**:
```cpp
#include "core/container.h"
#include "core/value.h"
```

**After**:
```cpp
#include "internal/thread_safe_container.h"
#include "internal/variant_value_v2.h"
```

---

## Test Plan

### How will we test this?

#### 1. Build Verification

```bash
# Full build test
cmake -B build -DUSE_UNIT_TEST=ON -DBUILD_BENCHMARKS=ON
cmake --build build 2>&1 | grep -i "error\|warning"
```

**Success criteria**: 0 compile errors, 0 related warnings

#### 2. Test Suite Execution

```bash
cd build && ctest --output-on-failure
```

**Success criteria**: All tests 100% pass

#### 3. Functionality Verification

```cpp
// Core functionality test
TEST(LegacyRemoval, CoreFunctionalityPreserved) {
    thread_safe_container container;

    // Store values
    container.set_value("int", 42);
    container.set_value("string", std::string("test"));

    // Retrieve values
    auto int_val = container.get_variant("int");
    ASSERT_TRUE(int_val.has_value());
    EXPECT_EQ(int_val->get<int32_t>().value(), 42);

    // Serialization
    auto bytes = container.serialize_array();
    EXPECT_GT(bytes.size(), 0);

    // Deserialization
    auto restored = thread_safe_container::deserialize(bytes);
    auto restored_val = restored->get_variant("int");
    EXPECT_EQ(restored_val->get<int32_t>().value(), 42);
}
```

#### 4. Binary Compatibility Test

```cpp
TEST(LegacyRemoval, BinaryCompatibility) {
    // Data generated by legacy system (pre-generated)
    std::vector<uint8_t> legacy_data = load_legacy_test_data();

    // Deserialize with new system
    auto container = thread_safe_container::deserialize(legacy_data);
    ASSERT_NE(container, nullptr);

    // Verify data
    // ...
}
```

#### Success Criteria
- [ ] 0 compile errors
- [ ] All tests pass
- [ ] Binary compatibility maintained
- [ ] No performance regression

---

## Risks and Mitigation

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Missing dependencies | Medium | High | Search dependencies before build |
| Binary incompatibility | Low | High | Convert with value_bridge |
| Performance regression | Low | Medium | Compare benchmarks |

---

## Rollback Plan

```bash
# Rollback on issues
git revert <commit-hash>
git push origin main
```

**Rollback triggers**:
- Compile failure
- Test failure rate > 5%
- Performance degradation > 10%

---

## Checklist

- [ ] Dependency analysis complete
- [ ] Remove optimized_value.h
- [ ] Remove value_pool.h
- [ ] Replace container.h with compatibility wrapper
- [ ] Remove value.h
- [ ] Remove value.cpp
- [ ] Remove container.cpp
- [ ] Update CMakeLists.txt
- [ ] Full build success
- [ ] 100% test pass
- [ ] Binary compatibility verified

---

**Created**: 2025-11-23
**Last Modified**: 2025-11-23
