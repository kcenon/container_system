name: Sanitizer Tests

on:
  push:
    branches: [ main, phase-* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sanitizer-tests:
    name: ${{ matrix.sanitizer }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04]
        sanitizer: [thread, address, undefined]
        build_type: [Debug]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Checkout common_system (optional dependency)
      uses: actions/checkout@v4
      continue-on-error: true
      with:
        repository: kcenon/common_system
        path: common_system
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        # Install GCC 12 for Clang + libstdc++ chrono compatibility
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build clang gcc-12 g++-12 libgtest-dev
        # Set GCC 12 as default for Clang sanitizer builds
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100

    - name: Set up compiler
      run: |
        echo "CC=clang" >> $GITHUB_ENV
        echo "CXX=clang++" >> $GITHUB_ENV
        # Force Clang to use GCC 12 headers (avoid GCC 13 chrono bugs)
        echo "CXXFLAGS=-isystem /usr/include/c++/12 -isystem /usr/include/x86_64-linux-gnu/c++/12 --gcc-toolchain=/usr" >> $GITHUB_ENV
        echo "CFLAGS=--gcc-toolchain=/usr" >> $GITHUB_ENV

    - name: Configure CMake with ${{ matrix.sanitizer }} sanitizer
      run: |
        # Check if common_system is available
        if [ -d "common_system" ]; then
          echo "Building with common_system support"
          BUILD_WITH_COMMON="ON"
        else
          echo "Building without common_system support"
          BUILD_WITH_COMMON="OFF"
        fi

        SANITIZER_FLAGS="-fsanitize=${{ matrix.sanitizer }} -fno-omit-frame-pointer -g"
        cmake -B build -S . \
          -GNinja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DBUILD_WITH_COMMON_SYSTEM=$BUILD_WITH_COMMON \
          -DCMAKE_CXX_FLAGS="-isystem /usr/include/c++/12 -isystem /usr/include/x86_64-linux-gnu/c++/12 --gcc-toolchain=/usr ${SANITIZER_FLAGS}" \
          -DCMAKE_C_FLAGS="--gcc-toolchain=/usr ${SANITIZER_FLAGS}" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=${{ matrix.sanitizer }}" \
          -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=${{ matrix.sanitizer }}" \
          -DBUILD_TESTS=ON \
          -DCONTAINER_BUILD_INTEGRATION_TESTS=ON \
          -DBUILD_CONTAINER_SAMPLES=OFF

    - name: Build with ${{ matrix.sanitizer }} sanitizer
      run: |
        cmake --build build -j

    - name: Run tests with ${{ matrix.sanitizer }} sanitizer
      run: |
        cd build
        echo "=== Running ${{ matrix.sanitizer }} sanitizer tests ==="
        ctest --output-on-failure --verbose
        CTEST_EXIT_CODE=$?

        echo ""
        echo "=== Test Exit Code: $CTEST_EXIT_CODE ==="

        if [ $CTEST_EXIT_CODE -ne 0 ]; then
          echo "::error::Sanitizer tests failed with exit code $CTEST_EXIT_CODE"
          if [ -f Testing/Temporary/LastTestsFailed.log ]; then
            echo "::error::Failed tests:"
            cat Testing/Temporary/LastTestsFailed.log
          fi
          exit $CTEST_EXIT_CODE
        fi

        echo "âœ… All ${{ matrix.sanitizer }} sanitizer tests passed"
      env:
        TSAN_OPTIONS: "halt_on_error=0 second_deadlock_stack=1 history_size=7"
        ASAN_OPTIONS: "halt_on_error=0 detect_leaks=1"
        UBSAN_OPTIONS: "halt_on_error=0 print_stacktrace=1"

    - name: Upload sanitizer logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: sanitizer-logs-${{ matrix.sanitizer }}-${{ matrix.os }}
        path: |
          build/Testing/Temporary/LastTest.log
          build/**/*.log
        retention-days: 7

  sanitizer-summary:
    name: Sanitizer Test Summary
    needs: sanitizer-tests
    runs-on: ubuntu-22.04
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "# Sanitizer Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Phase 0: Baseline Establishment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Sanitizer tests configured and running." >> $GITHUB_STEP_SUMMARY
        echo "Warnings allowed in Phase 0 for baseline establishment." >> $GITHUB_STEP_SUMMARY
